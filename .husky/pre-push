#!/usr/bin/env sh
. "$(dirname "$0")/_/husky.sh"

# Check code coverage for changed files only
echo "ğŸ§ª Checking code coverage for changed files (minimum 50% required)..."
npm run test:coverage:diff

if [ $? -ne 0 ]; then
    echo "âŒ Code coverage check failed for changed files!"
    echo "ğŸ“Š Changed files must have at least 50% coverage for all metrics"
    echo "ğŸ’¡ Run 'npm run test:coverage:diff' to see coverage for changed files"
    echo "ğŸ’¡ Run 'npm run test:coverage' to see full coverage report"
    exit 1
fi

echo "âœ… Code coverage check passed for changed files!"

# Run all tests including Docker integration tests
echo "Running all tests before push..."

# Run unit tests
npm run test:unit

# Run integration tests in Docker
echo "Running Docker integration tests..."
docker compose --profile test-integration up --abort-on-container-exit --exit-code-from test-integration

echo "All tests passed!"